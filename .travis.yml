language:
- ruby
install:
- bundle install
cache:
- bundler
script:
- LOG_LEVEL=error bundle exec rspec -f d
deploy:
- provider: lambda
  function_name: ItemCheckoutFeedUpdater-test
  description: A listener on the Item stream that produces an item checkouts feed
  region: us-east-1
  role: arn:aws:iam::224280085904:role/lambda_basic_execution
  runtime: ruby2.5
  module_name: application
  handler_name: handle_event
  environment_variables:
  - LOG_LEVEL=debug
  - MAX_CHECKOUTS_IN_MEMORY=100
  - NYPL_OAUTH_ID=AQECAHh7ea2tyZ6phZgT4B9BDKwguhlFtRC6hgt+7HbmeFsrsgAAAGowaAYJKoZIhvcNAQcGoFswWQIBADBUBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDJgrQmkr7pQa4WSF1gIBEIAnLgWjuqFllMpCQWGT/eC/7n/pxFN87zaoJF19zCRHH/ulh4BICTZf
  - NYPL_OAUTH_SECRET=AQECAHh7ea2tyZ6phZgT4B9BDKwguhlFtRC6hgt+7HbmeFsrsgAAAIcwgYQGCSqGSIb3DQEHBqB3MHUCAQAwcAYJKoZIhvcNAQcBMB4GCWCGSAFlAwQBLjARBAx8ZuLftGsgDmOxxBICARCAQ3ZSNw6hWlqI73kLJcs8Zg3O13PKiATfXXDUvGFim/KolFmQDCsVp7JFF9Jg01U++KNtcGJiVev7z3OAPNXc3fqGp6k
  - NYPL_OAUTH_URL=https://isso.nypl.org/
  - PLATFORM_API_BASE_URL=https://qa-platform.nypl.org/api/v0.1/
  - RANDOMIZATION_METHOD=uniform
  - S3_BUCKET_NAME=checkout-feed-test
  - S3_FEED_KEY=feed.xml
  - TZ=America/New_York
  skip_cleanup: true
  access_key_id: "$AWS_ACCESS_KEY_ID_QA"
  secret_access_key: "$AWS_SECRET_ACCESS_KEY_QA"
  on:
    branch: test-deploy
notifications:
  email:
    on_failure: always
env:
  global:
  - secure: HrW/1kKtOKgKkl6wPu6yvt+/SZA10CHmVlJK3n8S2nZh5c2P4Rv1/4z/R2DBVPA5vpoHGKrF17YChYr/RI9mJ1EaR/NdTnA1i1CMA3Ui3XutDG76eTR3uygDbfOXOq4b/PBgSi7EyXOWy9zXmQjc6/paIZCwBAZmXgBB8vZSG/DuWM96CElYc/J59Fiqh+z6I3SpIKDzkGia3m1IZeSBDBw25QWhdbPh3U8jDJM1CUZtn6cEpYOY7B0ZFz9pZ2Kgv1/QSENzuJi0lLhPwQtc4dJzIQ8sBisGvnf2c0DxQz2XrT5aCCOFLfl6MeDZU2/NBmlVGVDjpYyHRGxLmdBiqqaD7p4y3uIcr9uYZbek900JyhyMCipWGi8J74OQArFwjMorhNdKQdetwZ71dwvdcf61YQ//ThJScRD6iR8EmttVTwi0P0qRzqGqSIYELb++/Sb11m+vh/s2iFR5lkwCKZPei3MNK0EYWasxxN6MtSVoHjMOkMfxKS1FeHDvlW8IFX5T4nx8t2NKGK6dqF27npd0GpBw8c7nX5I/u0cCzeB9DJ7h2XDH1v5KugPWdETa0328WlnUCqez3X8S4DiMuErROjECTFZf81CF+j50+CMMtPNcgmUMckjAuyWylky/ccQHfTFkATL6GD15oWn7eD3ZOSoUnD90mhVi60QctJQ=
  - secure: CekIavmsh1zeCYYM7siNesWKfr4r013AfHYBPZEJG9dKmLViS1PCSZ1AjDbQi3pcnW0u9o9oPbjIrZJ7d4bibI2707MFM5h2mQWxS1GG5Irq6dlxDkisim8JmmeDLP03bLUZefHhVvt0jyGy94OcPz+SYjSr/04wtFZsPj62dG05VFBdGEahZoArFhaxWIIE/hwS9rxgSyUXZzgFla+CA3aaOP4TC4hv5Q2OusSPNjUjv8J/qKf8uynCz+g7cMINrrhnfG247gAe80/Yv6/gQYaxS5cPOzqPUcv8jnY+Wy9kJukoj8gyoup7lqoG/PSrxR4FWrklZcVRshZuZ6k2AnzB9LLH3Hr1AoVdMWo0Rg3i0PyVvKKScxpTSH6IrwLyEDoKbfQaednVoBMCUtjhsAVwkrpeo9ku7PzhLFkK1hFMUPxKrginzuJJ2X4LKi7tIdiDMUYPXbeFBXEkINogrOz/K0d6lq78BF25IEtx1vWI1R6/JjlyAiezJizA9xvjshwja695LFX4gqR+ucPIbS+uV91LTNQndquV2OWXFEQiOcskbKWBvjVrOIRzNyjATf+CeFmvlvGK3v91BZcA7A0cTIpr03gLHNqik8C5TElTMFmI1YG5bcxwBhLX4jJmoADrqpRq84O+JGJNqBg9qaed+uq0lRx/3irD4XQZiZk=
  - secure: f3N3LJIebjjqZA/iq/zk016TYKNo8GjnCx4lS/OP/VOG6vyZM+xkJvasLCOVcmYPHoPR4K2MzSs4nTqN1EWyo+Y/m3i/fAAeAMdq1r2g8eklWT5/P7f0G9PWQhW1E9uHNsrU7jYQA2y03vSdQF7WX8IpHM8f9cysAft5kpid7N2Oj2P2XC2vQWxSHx8utVDKLmSBjskEVXdbRDLgf/Qu/g4Ose+ZgeWsWXm1OjFxk0PtJCC1f5bKhLxPOZ7hL79CwPSV0bDx0vQfvuOgBIr/SsBWWQM2Px3v6533rPbwSa9bsOuMp7SAhQVkqgXuztU+eGJu/FnFSLdaIbo5RKFbc0Ei6mbRiXNa8IufcyVoh0cjKcCU+Rw3IxzmLJt/Xjr7Om2qUaVLg4KIYtH+Ebup3fhnjlWQTXNgq9AX/gF2tbLHdW0nqnCdyyUzZ8DQVTWVxICDWEAqRGjigw7YB/huaxDu8Xt8WjvjneZm5/McCjqRHkeRgFo5WBPemyCe3mtrLx7Qy8LRNtNuwzq5NJbfDtW4iSa63WMCR5i8NNumBSht6IrZM4+iatCyTZnw7i9sGrc+20de7uUCDr6fFeZLh/1MPeJtaPjdHyu8mGeE41qllhzmzicuwqQzWgoSZ/EXR6fVWazjWU/+xGfLqz9Q4ZXqc3dIymdosZ/VqYuOrvE=
  - secure: qy2VCsZjjLdkMIF87Tiws22074xltKPrN5jm56UMaxq1CEszJryD8bkecmAkCY4jBziXkpCnV3r5P0gtWl0ugg1C394KaVhmJT+qHZ7taew/annEIFKQbUR3jAqKH86HTOod32EvsCDNXdHfKDCR5j9FmpiD77QoUU1TqWE8yS5wQToQzKSObjeILyz3vD5kPjOjY6PUU8STY9Ncg7/61epZEtjPXD1bBfK3lfgvtPcXsUxJnGrYY7cvxGpwPe7oj1hqQ0NX5ugSjIbFREJF2HuyYY79J/rSUApGNf6txBJYp12nbj/+f1ysPpD7nISugl1LY37FiIX5l/zfNsaiTSaRbclXibLUSlwKrSRcyeg3d5T9FtcYtPZMFnDZB+qfZFaQckQLKwPa6wBd7UdQoTGPW8Z2Xr7p/EgHFqm/vuLiK0HL0gDLInAcDQHrjIUynMw4btPiIJuhxxYo3w165YzB0m4ggK/B4yYmlnmeKZnnt835B2XJRwlziOMsZondrPeFireuY+WLZpZ6E3P18RYKrLF0ifEusbgpP7m/9oOX92gK+jzL+QZMCN75eR5gsLwMAP8q+gZAsT/IfXEM5Yufj9Gv3IgXTVCv07zEpdcWfSIv74V6Hrl3Isti4EGdGETTDdoahHG3C9myNcOpNWhlhY9kidjrfursS5VNpEA=
  - secure: kWJqZTSOtfv0Hs5Cpt17PKVvbCAmuqP7+NV2gF+io3FzqGUYgAD3AGG83EuUJU7lbYxDLkgkgEghyRwkKUQTKE41E9P+/EAk0pVkngDnoIDqOwDeuNtbRGxv5pi5g5FXdrDs34RA7icUgTlVh3d5svE8usjaZXhp1tjSPXq8hthmQuU3/rhMnILhage7YobOrdLzbtglF/erJABo1ft1S6ALZMxNRmxUigRqkSy90JhTLILi3NSCNUyd6hWJj516fnMQRFeP6KAtiwayKA4SSJ/PL9q/zw0HgNyyPV1oWCwpOZh3hbxs5VCrGw6J5I/s1ncszUSrXnipTPIqP1UJyK0TE2QotV2Lld+wT3myxVlMkzj3HUO/Ak8pV9SWtNOJQVyLOoarLUUAGB8PZAIq9XUYZD8WldDG/Oc15MmA21IUxaKuBv6cZlJ7kvlaS0tN6MiuMaT6JGxh/y8aQtD1IPseLYNosrxQxnOrBZZkh+NqtdCAQz6EhQo3wgn8Il7QHBjqxIbxgKrYynGQSzChwtLzMf8+UU8IFmX9d3UT6n/UnC1pv+O0VSapYqWNbpDfiiTsdmLBuEirxhJAgjCLZwkw6F3vK8Q65csqVhGALS+cJNod/wJvA90oW0YzqnV/VnjbUuVwfAUg9v2Pa/uDSqHhQG+iDYrYZoswJVMPnV8=
  - secure: s94N4qmUHHqJRCxvNNM3Gm0+kyvkWJPDPYSrMoKUfwLT42jNJBxo7x+0C7aiESxly5Kqp5fwVsV3iQoHP6QXbOq2SppJwOAmKbrpdw8EJnvf8h8OyqR0+tT+V5hh9J8O5VgvXTh1tu7Bbd5KqKU6xWtRblqkXWIfowCaX2HnZGp4Ur2g8p+Vh1dggzx6Zf4mJkaXBQRLGSULE7QsnpEI8dYTvgzYM/OyzQTPfDtCzlny+QLNGJQ2L4FT8luE8gcG31KWgr0RG+ILJIl+/hty5i+Dv8L6QqMveZn6ljq9gbXB4Hyt0YrznLxhFrI/3AguF8VVnNQZJ/4c2wf7+wZtyxEaGVEyx2w5OkpVJvVAIZlUNx1D73Mtxo2biMDsf30/EOUMYQ87S8dYP9VQsA7ZHocjn0XdnPbK32nZb8CvB4qgejc/cteNEwOdOYoEP+RZkMjFDXanlXBVkUu3G2AG0oiidyDCDC7Jl6+51959gWr02XW70ZLH5fs16Y/fwbTLdSEEPxkwvxJX3SKUtbbl6n/8wVJlcwWfefXrBq7m8GUwGL7fTZGXk203TIH3BLmusyW/pNOkkQ7kBqBphSLs9FNr8WARQJ8H2KMNGJkOJt+Na1idUgRqqKfs1Ms9kcuRn1BbrNRVwFRqL9bBMPz5rhQca9JSU1ijbsV1t9zEpWQ=
